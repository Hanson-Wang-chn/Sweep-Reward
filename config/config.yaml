# ==============================================================================
# Sweep to Shapes - 多模态集成评估模块配置文件
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. 系统基础设置 (System Settings)
# ------------------------------------------------------------------------------
system:
  device: "cuda"            # 计算设备: "cuda" 或 "cpu"
  seed: 42                  # 随机种子，保证 DINO/VLM 采样的一致性
  image_size: [224, 224]    # 输入图像的标准化尺寸 [H, W]

# ------------------------------------------------------------------------------
# 2. 预处理流水线 (Preprocessing Pipeline)
# 目标：从含噪 RGB 图像中提取干净的乐高积木 Mask
# ------------------------------------------------------------------------------
preprocess:
  # 颜色分割：红色通常跨越 HSV 的 0 度，需要两个区间
  color_segmentation:
    hsv_range_1:
      lower: [0, 100, 70]   # [H, S, V]
      upper: [10, 255, 255]
    hsv_range_2:
      lower: [170, 100, 70]
      upper: [180, 255, 255]

  # 形态学操作：用于填补积木间隙(Closing)和去除噪点(Opening)
  morphology:
    closing:
      kernel_size: 5        # 闭运算核大小 (推荐 5x5)
      iterations: 2         # 执行次数，次数越多填补能力越强
      kernel_shape: "ellipse" # 核形状: "rect", "cross", "ellipse"
    opening:
      kernel_size: 3        # 开运算核大小 (推荐 3x3)
      iterations: 1         # 执行次数
      kernel_shape: "ellipse"

  # 平滑处理：生成软掩膜 (Soft Mask) 用于梯度计算
  smoothing:
    enable: true
    gaussian_kernel: 5      # 高斯模糊核大小 (必须是奇数)
    sigma: 1.5              # 标准差

# ------------------------------------------------------------------------------
# 3. 评估指标配置 (Metrics Configuration)
# ------------------------------------------------------------------------------
metrics:
  # --- A. 几何层 (Geometric Layer) ---
  geometric:
    # F1-Score 配置
    f1_score:
      epsilon: 1.0e-6       # 防止除零微小量

    # Elastic IoU (弹性 IoU) 配置
    elastic_iou:
      enable: true          # 是否启用弹性搜索（若 False 则计算标准 IoU）
      method: "grid_search"
      downsample_factor: 2  # 搜索时的降采样倍率 (1为原图)，越大越快但精度越低
      max_translation: 10   # 最大平移像素范围 (px)
      max_rotation: 10      # 最大旋转角度范围 (degrees)
      step_translation: 2   # 平移搜索步长 (px)
      step_rotation: 2      # 旋转搜索步长 (degrees)

  # --- B. 轮廓层 (Contour Layer) ---
  contour:
    chamfer_distance:
      edge_detection: "canny"
      canny_low_thresh: 50  # Canny 边缘检测低阈值
      canny_high_thresh: 150 # Canny 边缘检测高阈值
      normalization_lambda: 0.1 # 指数归一化系数: score = exp(-lambda * dist)
      truncate_distance: 20.0   # 距离截断阈值，防止离群点过度拉低分数

  # --- C. 语义特征层 (Semantic Layer) ---
  semantic:
    dinov2:
      model_repo: "facebookresearch/dinov2"
      model_name: "dinov2_vitl14" # 可选: vits14, vitb14, vitl14, vitg14
      layer: "cls"          # 提取特征层: "cls" 或 "patch" (本项目推荐 cls)
      resize_input: 224     # DINO 输入尺寸 (通常为 14 的倍数)

  # --- D. 感知层 (Perceptual Layer) ---
  perceptual:
    vlm:
      model_name: "google/gemini-3-pro-preview"
      api_key_env_var: "OPENROUTER_API_KEY" # 环境变量名，不要直接写 Key
      base_url: "https://openrouter.ai/api/v1"

      # 请求参数
      temperature: 0.0      # 低温度保证评分稳定性
      max_tokens: 1024
      timeout: 30           # 请求超时时间 (秒)
      max_retries: 5        # 失败重试次数 All images are black-and-white masks. White pixels represent LEGO bricks filled material. Black pixels represent empty space.

      # 提示词模板 (CoT)
      system_prompt: |
        # Role
        You are a highly permissive evaluator assessing a robot's ability to manipulate granular materials (Lego bricks) into rough shapes.
        **Your Core Principle**: Focus entirely on **Global Semantics**. Completely IGNORE local defects, noise, jagged edges, or disconnected strokes. If a human can glance at the image and guess the target letter, it is a SUCCESS.

        # Input
        - **Image 1**: The Goal Shape (Ideal mask).
        - **Image 2**: The Current Observation (Actual state).

        # Evaluation Criteria (Ultra-Lenient Scale)
        Assign a score based on "Recognizability" rather than "Precision":

        - **0.1 (Complete Failure)**: The workspace is empty or bricks are piled in a completely unrelated location. No resemblance whatsoever.
        - **0.3 (Abstract/Vague)**: You can see a "blob" of bricks in the correct general area. It doesn't look like the letter yet, but the robot moved bricks to the right place.
        - **0.5 (Emerging Shape)**: Key features are starting to appear. For example, for 'E', you see three horizontal blobs, even if they aren't connected to a vertical bar. **It looks broken, but the intent is visible.**
        - **0.7 (Recognizable)**: A human would say "That is an E." It might have large gaps, be very thick/thin, or have significant noise around it. **As long as the identity is clear, give at least 0.7.**
        - **0.9 (Success)**: The shape is clearly legible. It does NOT need to match the goal mask pixels perfectly. **If it looks like the letter, it is a 0.9.**

        # Step-by-Step Reasoning (Positive Bias)
        1. **The "Squint Test"**: If you squint your eyes (blur the details), does Image 2 look somewhat like Image 1? If YES, the score must be **>= 0.7**.
        2. **Ignore Noise**: Are there random bricks floating around? **Ignore them completely.** They do not lower the score.
        3. **Ignore Gaps**: Is the stroke broken? As long as the parts are aligned (e.g., a dashed line instead of a solid line), treat it as a solid line.

        # Output Format
        {
          "reasoning": "Briefly state if the letter is recognizable despite defects...",
          "score": <float between 0.1 and 0.9>
        }


# ------------------------------------------------------------------------------
# 4. 集成机制 (Ensemble Mechanism)
# ------------------------------------------------------------------------------
ensemble:
  # 门控机制：节省算力
  gating:
    enable: true
    threshold: 0.4     # 如果基础几何得分 (Geometric Score) 低于此阈值，直接返回失败，不调用 DINO/VLM

  # 各模块权重 (总和应为 1.0)
  weights:
    geometric: 0.35    # IoU/F1: 负责基础重合度
    contour: 0.25      # Chamfer: 负责边缘细节
    semantic: 0.20     # DINO: 负责结构与布局
    perceptual: 0.20   # VLM: 负责人类观感与Corner Case

# ------------------------------------------------------------------------------
# 5. 调试与日志 (Debugging & Logging)
# ------------------------------------------------------------------------------
debug:
  # 单张图片模式设置
  single_image:
    enable_visualization: true  # 是否保存处理过程中的图片 (Mask, Edges, Heatmaps)
    save_metrics_to_json: true  # 将每次评估的详细指标保存为 JSON

  # 多张图片/批量模式设置
  multi_image:
    enable_visualization: false # 批量模式下通常关闭可视化以提高效率
    save_metrics_to_json: true  # 保存汇总的 JSON 结果

  vis_output_dir: "./logs"
  log_level: "INFO"           # "DEBUG", "INFO", "WARNING", "ERROR"

  # 向后兼容的默认设置（当未指定模式时使用）
  enable_visualization: true
  save_metrics_to_json: true
