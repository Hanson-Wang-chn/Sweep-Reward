# ==============================================================================
# Sweep to Shapes - 多模态集成评估模块配置文件
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. 系统基础设置 (System Settings)
# ------------------------------------------------------------------------------
system:
  device: "cuda"            # 计算设备: "cuda" 或 "cpu"
  seed: 42                  # 随机种子，保证 DINO/VLM 采样的一致性
  image_size: [224, 224]    # 输入图像的标准化尺寸 [H, W]

# ------------------------------------------------------------------------------
# 2. 预处理流水线 (Preprocessing Pipeline)
# 目标：从含噪 RGB 图像中提取干净的乐高积木 Mask
# ------------------------------------------------------------------------------
preprocess:
  # 是否对 current 图片应用形态学操作（开闭运算）
  # true: 对 current 图片使用与 goal 相同的形态学预处理
  # false: current 图片仅进行颜色分割，不使用形态学操作
  preprocess_current: true

  # 颜色分割：红色通常跨越 HSV 的 0 度，需要两个区间
  color_segmentation:
    hsv_range_1:
      lower: [0, 100, 70]   # [H, S, V]
      upper: [10, 255, 255]
    hsv_range_2:
      lower: [170, 100, 70]
      upper: [180, 255, 255]

  # 形态学操作：用于填补积木间隙(Closing)和去除噪点(Opening)
  morphology:
    closing:
      kernel_size: 5        # 闭运算核大小 (推荐 5x5)
      iterations: 1         # 执行次数，次数越多填补能力越强
      kernel_shape: "ellipse" # 核形状: "rect", "cross", "ellipse"
    opening:
      kernel_size: 3        # 开运算核大小 (推荐 3x3)
      iterations: 1         # 执行次数
      kernel_shape: "ellipse"

  # 平滑处理：生成软掩膜 (Soft Mask) 用于梯度计算
  smoothing:
    enable: true
    gaussian_kernel: 5      # 高斯模糊核大小 (必须是奇数)
    sigma: 1.5              # 标准差

# ------------------------------------------------------------------------------
# 3. 评估指标配置 (Metrics Configuration)
# ------------------------------------------------------------------------------
metrics:
  # --- A. 几何层 (Geometric Layer) ---
  geometric:
    # F1-Score 配置
    f1_score:
      epsilon: 1.0e-6       # 防止除零微小量

    # Elastic IoU (弹性 IoU) 配置
    elastic_iou:
      enable: true          # 是否启用弹性搜索（若 False 则计算标准 IoU）
      method: "grid_search"
      downsample_factor: 2  # 搜索时的降采样倍率 (1为原图)，越大越快但精度越低
      max_translation: 10   # 最大平移像素范围 (px)
      max_rotation: 10      # 最大旋转角度范围 (degrees)
      step_translation: 2   # 平移搜索步长 (px)
      step_rotation: 2      # 旋转搜索步长 (degrees)
    sinkhorn:
      enable: true
      downsample: 4         # 下采样倍率，降低 Sinkhorn 的计算量
      epsilon: 0.05         # 熵正则系数，越大越平滑
      max_iters: 40         # Sinkhorn 迭代次数
      normalization_lambda: 0.08  # 将散度映射到相似度的缩放系数
      clip_divergence: 4.0  # 截断过大的散度值，避免数值爆炸

  # --- B. 轮廓层 (Contour Layer) ---
  contour:
    chamfer_distance:
      edge_detection: "canny"
      canny_low_thresh: 50  # Canny 边缘检测低阈值
      canny_high_thresh: 150 # Canny 边缘检测高阈值
      normalization_lambda: 0.1 # 指数归一化系数: score = exp(-lambda * dist)
      truncate_distance: 20.0   # 距离截断阈值，防止离群点过度拉低分数

  # --- C. 语义特征层 (Semantic Layer) ---
  semantic:
    dinov2:
      model_repo: "facebookresearch/dinov2"
      model_name: "dinov2_vitl14" # 可选: vits14, vitb14, vitl14, vitg14
      layer: "cls"          # 提取特征层: "cls" 或 "patch" (本项目推荐 cls)
      resize_input: 224     # DINO 输入尺寸 (通常为 14 的倍数)
      enable: true
    lpips:
      enable: true
      net: "alex"           # 可选: alex, vgg
      normalization_lambda: 5.0  # 越大惩罚越重
    dists:
      enable: true
      normalization_lambda: 15.0

  # --- D. 感知层 (Perceptual Layer) ---
  perceptual:
    vlm:
      # model_name: "google/gemini-3-pro-preview"
      model_name: "openai/gpt-5.2"
      api_key_env_var: "OPENROUTER_API_KEY" # 环境变量名，不要直接写 Key
      base_url: "https://openrouter.ai/api/v1"

      # 请求参数
      temperature: 0.0      # 低温度保证评分稳定性
      max_tokens: 1024
      timeout: 30           # 请求超时时间 (秒)
      max_retries: 5        # 失败重试次数 All images are black-and-white masks. White pixels represent LEGO bricks filled material. Black pixels represent empty space.

      # 提示词模板 (CoT)
      system_prompt: |
        # Role
        You are a pragmatic robot evaluator assessing a "Lego Sweeping" task. You understand that sweeping granular objects (small Lego bricks) results in naturally rough edges and noise. **Perfection is not required.** Your goal is to judge if the robot has successfully formed the *semantic shape*.

        # Input
        - **Image 1**: The Goal Shape (Ideal binary mask).
        - **Image 2**: The Current Observation (Actual state of bricks).

        # Context & Lenience Guidelines
        - **Granular Material**: The objects are small bricks. Straight lines will inevitably look jagged or "pixelated." **Do not penalize for jagged edges.**
        - **Stray Bricks**: A moderate amount of scattered bricks (noise) outside the main shape is acceptable and expected. **Ignore isolated background noise.**
        - **Focus**: Prioritize **Topological Correctness** (e.g., "Does it look like the letter?") over **Geometric Precision** (e.g., "Are the lines perfectly straight?").

        # Evaluation Criteria (0.1 - 0.9)
        Please assign a score based on the following relaxed standards:

        - **0.1 (Unrecognizable)**: The bricks are piled randomly. No coherent shape is visible.
        - **0.3 (Attempted but Failed)**: You can guess what the robot tried to do, but major parts are missing (e.g., an 'E' missing the middle bar) or the shape is broken into disconnected islands.
        - **0.5 (Passable)**: The shape is clearly recognizable as the target letter/symbol. It may be significantly thicker/thinner than the goal, or have 1-2 moderate gaps, but the identity is unambiguous.
        - **0.7 (Good Success)**: The shape matches the goal's topology perfectly. The strokes are connected. There might be some fuzzy edges or a few scattered bricks nearby, but the main structure is solid.
        - **0.9 (Excellent)**: The shape is distinct, correctly oriented, and topologically complete. Even if the borders are wavy or not perfectly aligned with the goal mask pixels, visually, it is a great result for a robot.

        # Reasoning Steps
        1. **Identify**: Can you instantly recognize the shape in Image 2 as the shape in Image 1 without guessing? If yes, start from score 0.5.
        2. **Topology Check**: Are all necessary strokes present and connected? (e.g., "Z" has top, diagonal, bottom). If yes, boost score to 0.7+.
        3. **Noise Tolerance**: Is the noise distracting? If the main shape is prominent enough to ignore the noise, maintain the high score.

        # Output Format
        {
          "reasoning": "Brief justification focusing on recognizability and topology...",
          "score": <float between 0.1 and 0.9>
        }



# ------------------------------------------------------------------------------
# 4. 集成机制 (Ensemble Mechanism)
# ------------------------------------------------------------------------------
ensemble:
  # 门控机制：节省算力
  gating:
    enable: true
    metric: "f1"       # 门控使用的指标：建议使用 f1
    threshold: 0.4     # 如果基础几何得分 (Geometric Score) 低于此阈值，直接返回失败，不调用 DINO/VLM

  # 各模块权重 (总和应为 1.0)
  weights:
    geometric:
      iou: 0.05
      elastic_iou: 0.10
      f1: 0.15
      sinkhorn: 0.05
    contour:
      chamfer: 0.25
    semantic:
      dino: 0.12
      lpips: 0.05
      dists: 0.03
    perceptual:
      vlm: 0.20

# ------------------------------------------------------------------------------
# 5. 调试与日志 (Debugging & Logging)
# ------------------------------------------------------------------------------
debug:
  # 单张图片模式设置
  single_image:
    enable_visualization: true  # 是否保存处理过程中的图片 (Mask, Edges, Heatmaps)
    save_metrics_to_json: true  # 将每次评估的详细指标保存为 JSON

  # 多张图片/批量模式设置
  multi_image:
    enable_visualization: false # 批量模式下通常关闭可视化以提高效率
    save_metrics_to_json: true  # 保存汇总的 JSON 结果

  vis_output_dir: "./logs"
  log_level: "INFO"           # "DEBUG", "INFO", "WARNING", "ERROR"

  # 向后兼容的默认设置（当未指定模式时使用）
  enable_visualization: true
  save_metrics_to_json: true

  # VLM 调试设置
  save_vlm_imgs: true        # 是否保存 VLM 的输入图片（调试用）
